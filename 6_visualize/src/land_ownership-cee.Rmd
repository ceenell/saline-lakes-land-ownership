---
title: "Land Ownership"
output: html_document
date: "2022-10-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_lbs, echo = FALSE, message = FALSE, warnings = FALSE}
library(tidyverse)
library(here)
library(leaflet)
library(scico)
library(scales)
library(sf)
library(ggmap)
library(ggspatial)
library(rnaturalearthdata)
library(rnaturalearth)
library(ggsn)
library(rmapshaper)
library(terra)
library(tidyterra)
library(maptiles)


```

# Read in all shapefiles
```{r}
proj <- '+proj=aea +lat_0=31.3 +lon_0=-114.5 +lat_1=37.2 +lat_2=43.2 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs'

# Read in watershed extents
watershed_ext <- st_read(here('1_fetch/in/Vizlab-saline_lakes_spatial_data/Saline_lake_watershed_extents/lake_watersheds.shp')) |> st_transform(proj)
#watershed_ext_5070 <- st_read(here('1_fetch/in/Vizlab-saline_lakes_spatial_data/Saline_lake_watershed_extents/lake_watersheds_5070.shp')) 

# saline lake 
saline_lakes <- st_read(here('1_fetch/in/Vizlab-saline_lakes_spatial_data/saline_lakes/saline_lakes.shp')) |> st_transform(proj)
saline_lakes |> st_union()
#saline_lakes_5070 <- st_read(here('1_fetch/in/Vizlab-saline_lakes_spatial_data/saline_lakes/saline_lakes_5070.shp'))  

# Great Basin Dessert Band
gbd_bnd <- st_read(here('1_fetch/in/Vizlab-saline_lakes_spatial_data/GreatBasinDessertBnd_220721/GreatBasinDessertBnd.shp')) %>% 
  st_transform(crs = proj) |> ms_simplify()

#PAD/land ownership 
pad <- st_read(here('1_fetch/in/Shapefiles_220721/PADUS_3_0VA.shp')) %>%  
  st_transform(crs = proj) %>% 
  select(OBJECTI, Mng_Typ, Mang_Nm, MngNm_L,Unit_Nm, GIS_Acr, MngTp_D, MngNm_D, BndryNm, ST_Name) |>
  mutate(area = st_area(geometry))
pad

# states
states <- st_read(here('1_fetch/in/states_shp/statesp010g.shp')) %>% 
  st_transform(crs = proj) |>
  ms_simplify()
```

# Reduce complexity of spatial files for mapping purposes 
```{r}
# Aggregate PAD by major groupings
pad_simp <- pad |> ms_simplify() |> st_buffer(0)
pad_agg <- pad_simp |> 
  group_by(Mng_Typ, Mang_Nm, MngTp_D, MngNm_D, MngNm_L, Unit_Nm, ST_Name) |> 
  summarize() 
pad_agg

## total area of gdba

gbd_bnd |> 
  ggplot() +
  geom_sf(fill = NA) + 
  geom_sf(data = pad_agg, fill = NA, color = 'pink', alpha = 0.5) +
  theme_void()

```

# Intersect `pad` to each of `gbd_bnd`, `saline_lakes`, and `watershed_ext` 
```{r}

## total area
gbd_area <- gbd_pad_int |>
  st_union() |>
  st_area()

gbd_pad_int <- gbd_bnd |> 
  st_intersection(pad_agg) |> 
  st_buffer(0) |> 
  mutate(Mng_level = case_when(
    Mng_Typ == 'FED' ~ 'Federal',
    Mng_Typ == 'NGO' ~ 'NGO',
    Mng_Typ %in% c('PVT','UNK') ~ 'Private or Unknown',
    Mng_Typ %in% c('LOC','STAT', 'DIST', 'JNT') ~ 'State/Regional/Local',
    Mng_Typ == 'TRIB' ~ 'Tribal Land',
    TRUE ~ Mng_Typ
  )) |>
  mutate(area_perc = 100*(st_area(geometry)/gbd_area))

gbd_pad_int |>
  group_by()

#saline_lakes_pad_int <- saline_lakes |> st_intersection(pad_agg) |> st_buffer(0)
watershed_ext_pad_int <- watershed_ext |> 
  st_intersection(pad_agg) |> 
  st_buffer(0) |> 
  mutate(Mng_level = case_when(
    Mng_Typ == 'FED' ~ 'Federal',
    Mng_Typ == 'NGO' ~ 'NGO',
    Mng_Typ %in% c('PVT','UNK') ~ 'Private or Unknown',
    Mng_Typ %in% c('LOC','STAT', 'DIST', 'JNT') ~ 'State/Regional/Local',
    Mng_Typ == 'TRIB' ~ 'Tribal Land',
    TRUE ~ Mng_Typ
  ))

```
```{r}
# basemap
us <- c(left = -125, bottom = 30, right = -105, top = 45)
basemap <- get_stamenmap(us, zoom = 7, maptype = "terrain-background", 
                   color = 'bw', force = TRUE) #%>% 

pad_grps <- gbd_pad_int |>
  distinct(Mng_Typ, Mang_Nm, MngNm_D,MngNm_L)
pad_grps |> View()

unique(gbd_pad_int$MngNm_L)

states_sf <- states |> 
  filter(NAME %in% c('California','Nevada', 'Utah','Oregon', 'Idaho', 'Arizona','Washington','Wyoming'))
states_crop <- states |> st_crop(gbd_bnd |> st_buffer(70*1000))

pal_land <- tibble(MngTp_D = unique(gbd_pad_int$MngTp_D),
                   color = c('white'))

basemap <- get_tiles(x = states_crop, provider = "CartoDB.PositronNoLabels", crop = T, verbose = T, zoom = 7, forceDownload = T)
basemap

```

```{r}
## Land ownership by management level, and broken down

## for gdba
gbd_mg <- gbd_pad_int |> 
  mutate(Mng_level = case_when(
    Mng_Typ == 'FED' ~ 'Federal',
    Mng_Typ == 'NGO' ~ 'NGO',
    Mng_Typ %in% c('PVT','UNK') ~ 'Private or Unknown',
    Mng_Typ %in% c('LOC','STAT', 'DIST', 'JNT') ~ 'State/Regional/Local',
    Mng_Typ == 'TRIB' ~ 'Tribal Land',
    TRUE ~ Mng_Typ
  )) |>
  group_by(Mng_level, MngNm_D) |>
  summarize(area = st_area(MngNm_D))

## total area by level and subcategory


```
# Plot land ownership map of Great Bsain Desert Area
```{r, fig.width = 10, fig.height = 10}

gbd_pad_int |> pull(MngNm_D) |> unique()

salin

gbd_mg |>
  ggplot() +
  geom_spatraster_rgb(data = basemap) +
  #geom_sf(data = states_sf, fill = NA, color = 'grey') +
  #geom_sf(data = gbd_bnd, fill = NA, color = 'black') +
  geom_sf(
    aes(fill = Mng_level),
    color = NA
  ) +
  geom_sf(data = saline_lakes|> st_union(), color = 'white', fill = 'white', alpha = 0.4) +
  theme_void() +
  theme(plot.background = element_rect(fill = 'white', color = NA),
        legend.position = 'bottom') +
  scale_fill_scico_d(palette = 'bamako', direction = -1) +
  #scale_fill_manual(values = scico(n = 7, palette = 'bamako')[c(3,6,4,1,5)]) +
  guides(fill = guide_legend(
    title = 'Land Ownership',
    title.theme = element_text(face = 'bold'),
    direction = 'horizontal'
  ))

ggsave('land_GreatDesertBasinArea.png', width = 8, height = 8)

```

# add in an area count column to the dfs
```{r}
gbd_pad_int$area <- st_area(gbd_pad_int$geometry)
saline_lakes_5070_pad_int$area <- st_area(saline_lakes_5070_pad_int$geometry)
watershed_ext_huc10_5070_pad_int$area <- st_area(watershed_ext_huc10_5070_pad_int$geometry)
watershed_ext_5070_pad_int$area <- st_area(watershed_ext_5070_pad_int$geometry)

# plot the layers to visually check result of intersect
plot(gbd_pad_int$geometry, col='green')
plot(pad$geometry)
plot(gbd_pad_int$geometry, col='red')

```

# group data by Mng_Typ and calculate the total land area per Mng_Typ
```{r}
gbdByMng <- gbd_pad_int %>%
  group_by(Mng_Typ) %>%
  summarise(areaMng_Typ = sum(area))

# change data type of areaMng_Typ field to numeric (from 'S3: units' with m^2 suffix)
gbdByMng$areaMng_Typ <- as.numeric(gbdByMng$areaMng_Typ)

salineLakes5070ByMng <- saline_lakes_5070_pad_int %>%
  group_by(Mng_Typ, GNIS_Nm) %>%
  summarise(areaMng_Typ = sum(area))

salineLakes5070ByMng$areaMng_Typ <- as.numeric(salineLakes5070ByMng$areaMng_Typ)

watershedExtHuc10_5070ByMng <- watershed_ext_huc10_5070_pad_int %>%
  group_by(Mng_Typ, HUC10_N) %>%
  summarise(areaMng_Typ = sum(area))

watershedExtHuc10_5070ByMng$areaMng_Typ <- as.numeric(watershedExtHuc10_5070ByMng$areaMng_Typ)

watershedExt5070ByMng <- watershed_ext_5070_pad_int %>%
  group_by(Mng_Typ, lk_w_st) %>%
  summarise(areaMng_Typ = sum(area))

watershedExt5070ByMng$areaMng_Typ <- as.numeric(watershedExt5070ByMng$areaMng_Typ)
```

# group data by MngNm_D and calculate the total land area per MngNm_D (more detailed Manamgement Types)
```{r}
gbdByMngNm <- gbd_pad_int %>%
  group_by(MngNm_D) %>%
  summarise(areaMngNm_Typ = sum(area))

# change data type of areaMng_Typ field to numeric (from 'S3: units' with m^2 suffix)
gbdByMngNm$areaMngNm_Typ <- as.numeric(gbdByMngNm$areaMngNm_Typ)

salineLakes5070ByMngNm <- saline_lakes_5070_pad_int %>%
  group_by(MngNm_D, GNIS_Nm) %>%
  summarise(areaMngNm_Typ = sum(area))

salineLakes5070ByMngNm$areaMngNm_Typ <- as.numeric(salineLakes5070ByMngNm$areaMngNm_Typ)

watershedExtHuc10_5070ByMngNm <- watershed_ext_huc10_5070_pad_int %>%
  group_by(MngNm_D, HUC10_N) %>%
  summarise(areaMngNm_Typ = sum(area))

watershedExtHuc10_5070ByMngNm$areaMngNm_Typ <- as.numeric(watershedExtHuc10_5070ByMngNm$areaMngNm_Typ)

watershedExt5070ByMngNm <- watershed_ext_5070_pad_int %>%
  group_by(MngNm_D, lk_w_st) %>%
  summarise(areaMngNm_Typ = sum(area))

watershedExt5070ByMngNm$areaMngNm_Typ <- as.numeric(watershedExt5070ByMngNm$areaMngNm_Typ)
```


# Map of land ownership
```{r}
ggplot(data = gbdByMngNm%>% st_transform(crs=st_crs(saline_lakes))) +
  geom_sf(aes(fill = MngNm_D))

ggplot(data = salineLakes5070ByMng) +
  geom_sf(aes(fill = Mng_Typ))

ggplot(data = watershedExtHuc10_5070ByMngNm_grp) +
  geom_sf(aes(fill = MngGroup))

ggplot(data = watershedExt5070ByMng) +
  geom_sf(aes(fill = Mng_Typ))
  
```

# Group some of the Management Type names to reduce colors needed 
```{r}
gbdByMngNm_grp <- gbdByMngNm %>% 
  mutate(MngGroup = case_when(
   MngNm_D == "American Indian Lands" ~ "Native American areas", 
   MngNm_D == "Agricultural Research Service" ~ "Federal - other",
    MngNm_D == "Army Corps of Engineers" ~ "Federal - other", 
    MngNm_D == "Department of Energy" ~ "Federal - other",
    MngNm_D == "Natural Resources Conservation Service" ~ "Federal - other", 
    MngNm_D == "State Department of Conservation" ~ "State entities",
    MngNm_D == "Other or Unknown State Land" ~ "State entities", 
    MngNm_D == "State Park and Recreation" ~ "State entities",
    MngNm_D == "State Department of Land" ~ "State entities",
    MngNm_D == "State Fish and Wildlife" ~ "State entities", 
    MngNm_D == "State Department of Natural Resources" ~ "State entities", 
    MngNm_D == "State Land Board" ~ "State entities", 
    MngNm_D == "Regional Agency Land" ~ "Regional entites",
    MngNm_D == "County Land" ~ "Municipal entities",
    MngNm_D == "City Land" ~ "Municipal entities", 
    MngNm_D == "Non-Governmental Organization" ~ "NGO",
    TRUE ~ MngNm_D
  ))

salineLakesByMngNm_grp <- salineLakes5070ByMngNm %>% 
  mutate(MngGroup = case_when(
   MngNm_D == "American Indian Lands" ~ "Native American areas", 
   MngNm_D == "Agricultural Research Service" ~ "Federal - other",
    MngNm_D == "Army Corps of Engineers" ~ "Federal - other", 
    MngNm_D == "Department of Energy" ~ "Federal - other",
    MngNm_D == "Natural Resources Conservation Service" ~ "Federal - other", 
    MngNm_D == "State Department of Conservation" ~ "State entities",
    MngNm_D == "Other or Unknown State Land" ~ "State entities", 
    MngNm_D == "State Park and Recreation" ~ "State entities",
    MngNm_D == "State Department of Land" ~ "State entities",
    MngNm_D == "State Fish and Wildlife" ~ "State entities", 
    MngNm_D == "State Department of Natural Resources" ~ "State entities", 
    MngNm_D == "State Land Board" ~ "State entities", 
    MngNm_D == "Regional Agency Land" ~ "Regional entites",
    MngNm_D == "County Land" ~ "Municipal entities",
    MngNm_D == "City Land" ~ "Municipal entities", 
    MngNm_D == "Non-Governmental Organization" ~ "NGO",
    TRUE ~ MngNm_D
  ))


```

```{r}
mapBound <- gbdByMngNm_grp %>% st_transform(crs=st_crs(4326)) %>% 
  st_bbox() %>% st_as_sfc() %>% st_buffer(0.25) %>%
  st_bbox() %>% as.numeric()

man_basemap <- ggmap::get_stamenmap(bbox = mapBound, zoom = 6, messaging = FALSE, maptype = 'terrain-lines')

manualcolors<-c('black','forestgreen', 'red2', 'orange', 'cornflowerblue', 'darkolivegreen4', 'indianred1', 'tan4', 'darkblue','firebrick4',  'yellowgreen', 'lightsalmon', 'tan3','darkgray', 'wheat4', 'moccasin', 'mediumvioletred','cadetblue1',
                "darkolivegreen1" , "tomato3" , "#7CE3D8","gainsboro")

greatBasin <- ggmap(man_basemap) +
  # geom_sf(data = states %>% st_transform(4326),
  #              aes(group = STATE_ABBR),
  #         alpha = 0.8,
  #         fill = NA,
  #         color = "grey60", inherit.aes = FALSE)+
  geom_sf(data = gbdByMngNm_grp %>% st_transform(4326), aes(fill = MngGroup, color = MngGroup), inherit.aes = FALSE) +
  coord_sf(crs = st_crs(4326)) +
scale_color_manual(values = manualcolors) +
  scale_fill_manual(values = manualcolors) + 
  labs(fill='Management Type') +
  guides(color="none", 
         fill = guide_legend(override.aes=list(linetype = 0))) + 
  theme_void() +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.2, "in"), pad_y = unit(0.15, "in"),
                         height = unit(0.5, "in"), width= unit(0.2, "in"),
                         style = north_arrow_orienteering(fill = c("black", "black"),
                                                          line_col = "black",
                                                          text_col = "black"))


ggsave(here("6_visualize/out/greatBasin.png"), width = 10, height = 7, dpi = 500)
```

```{r}
mapBound <- salineLakesByMngNm_grp %>% st_transform(crs=st_crs(4326)) %>% 
  st_bbox() %>% st_as_sfc() %>% st_buffer(0.25) %>%
  st_bbox() %>% as.numeric()

man_basemap <- ggmap::get_stamenmap(bbox = mapBound, zoom = 7, messaging = FALSE, maptype = 'terrain-lines')

salineLakes <- ggmap(man_basemap) +
  # geom_sf(data = states %>% st_transform(4326),
  #              aes(group = STATE_ABBR),
  #         alpha = 0.3,
  #         fill = NA,
  #         color = "grey60", inherit.aes = FALSE,
  #         linetype = "11", size = 0.8) +
  geom_sf(data = salineLakesByMngNm_grp %>% st_transform(4326), aes(fill = MngGroup, color=MngGroup),
          inherit.aes = FALSE) + 
  coord_sf(crs = st_crs(4326)) + 
scale_color_manual(values = manualcolors) +
  scale_fill_manual(values = manualcolors) + 
 labs(fill='Management Type') +
  guides(color="none", 
         fill = guide_legend(override.aes=list(linetype = 0))) +
  theme_void() +
  theme(legend.position="bottom",
        legend.title=element_blank(),
        legend.key = element_blank()) +
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.2, "in"), pad_y = unit(0.15, "in"),
                         height = unit(0.5, "in"), width= unit(0.2, "in"),
                         style = north_arrow_orienteering(fill = c("black", "black"),
                                                          line_col = "black",
                                                          text_col = "black"))

ggsave(here("6_visualize/out/salineLakes.png"), width = 10, height = 7, dpi = 500)

```

```{r}
mapBound <- watershedExtHuc10_5070ByMngNm_grp %>% st_transform(crs=st_crs(4326)) %>% 
  st_bbox() %>% st_as_sfc() %>% st_buffer(0.25) %>%
  st_bbox() %>% as.numeric()

man_basemap <- ggmap::get_stamenmap(bbox = mapBound, zoom = 6, messaging = FALSE, maptype = 'terrain-lines')

salineLakes <- ggmap(man_basemap) +
  # geom_sf(data = states %>% st_transform(4326),
  #              aes(group = STATE_ABBR),
  #         alpha = 0.3,
  #         fill = NA,
  #         color = "grey60", inherit.aes = FALSE,
  #         linetype = "11", size = 0.8) +
  geom_sf(data = watershedExtHuc10_5070ByMngNm_grp %>% st_transform(4326), aes(fill = MngGroup, color=MngGroup),
          inherit.aes = FALSE) + 
  coord_sf(crs = st_crs(4326)) + 
scale_color_manual(values = manualcolors) +
  scale_fill_manual(values = manualcolors) + 
 labs(fill='Management Type') +
  guides(color="none", 
         fill = guide_legend(override.aes=list(linetype = 0))) +
  theme_void() +
  theme(legend.position="bottom",
        legend.title=element_blank(),
        legend.key = element_blank()) +
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.2, "in"), pad_y = unit(0.15, "in"),
                         height = unit(0.5, "in"), width= unit(0.2, "in"),
                         style = north_arrow_orienteering(fill = c("black", "black"),
                                                          line_col = "black",
                                                          text_col = "black"))

ggsave(here("6_visualize/out/watershedExtentHuc10.png"), width = 10, height = 7, dpi = 500)
```


